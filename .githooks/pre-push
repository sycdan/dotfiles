#!/usr/bin/env bash
# Pre-push hook: lint checks + integration tests.
# Activate with: git config core.hooksPath .githooks

set -uo pipefail

PASS=0
FAIL=0
ERRORS=()

ok()   { echo "  ‚úÖ $1"; PASS=$((PASS + 1)); }
fail() { echo "  ‚ùå $1"; FAIL=$((FAIL + 1)); ERRORS+=("$1"); }

# ---------------------------------------------------------------------------
# Ruff
# ---------------------------------------------------------------------------
if command -v ruff &>/dev/null; then
  echo "ruff..."
  if ruff check . --quiet 2>/dev/null;          then ok "ruff check";  else fail "ruff check";  fi
  if ruff format --check . --quiet 2>/dev/null; then ok "ruff format"; else fail "ruff format"; fi
else
  echo "ruff not found, skipping lint checks"
fi

# ---------------------------------------------------------------------------
# Integration tests
# ---------------------------------------------------------------------------
echo "integration tests..."

if ! command -v scaf &>/dev/null; then
  echo "‚ùå scaf not found"
  echo "üí° pip install git+https://github.com/sycdan/scaf"
  exit 1
fi

if ! ls C:/wsl-images/*.tar >/dev/null 2>&1; then
  echo "‚ùå No WSL image found in C:/wsl-images/"
  echo "üí° Export an existing distro first:  scaf call wsl/export <distro>"
  exit 1
fi

# ---------------------------------------------------------------------------
# create ‚Üí find ‚Üí nuke a known test project
# ---------------------------------------------------------------------------
TESTNAME="a_b_c.1-2-3"
WIN_HOME=$(echo "$USERPROFILE" | tr '\\' '/')
TESTDIR="$WIN_HOME/Projects/$TESTNAME"

cleanup() {
  scaf call wsl/nuke "$TESTNAME" --force >/dev/null 2>&1 || true
  rm -rf "$TESTDIR" 2>/dev/null || true
}

trap cleanup EXIT
cleanup

# workon --create exercises: pick ‚Üí wsl/find ‚Üí wsl/list ‚Üí wsl/create ‚Üí wsl/path/get ‚Üí wsl/activate
if scaf call project/workon "$TESTNAME" --create -- exit 2>/dev/null; then
  ok "workon"
else
  fail "workon"
fi

cleanup
trap - EXIT

# ---------------------------------------------------------------------------
# Summary
# ---------------------------------------------------------------------------
echo ""
echo "$PASS passed, $FAIL failed"
if [[ $FAIL -gt 0 ]]; then
  printf '  - %s\n' "${ERRORS[@]}"
  exit 1
fi
